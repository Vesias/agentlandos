// Browser compatibility utilities for speech recognition and other web APIs
'use client'

import { mobileUtils } from './mobile-utils'

export interface BrowserInfo {
  name: string
  version: string
  isMobile: boolean
  isIOS: boolean
  isAndroid: boolean
  supportsWebkitSpeech: boolean
  supportsMozillaSpeech: boolean
  supportsMediaDevices: boolean
  supportsAudioContext: boolean
  supportsWebGL: boolean
  supportsServiceWorker: boolean
}

export interface CompatibilityCheck {
  compatible: boolean
  message: string
  recommendations: string[]
  level: 'excellent' | 'good' | 'limited' | 'none'
}

export interface FeatureSupport {
  speechRecognition: CompatibilityCheck
  mediaRecording: CompatibilityCheck
  audioProcessing: CompatibilityCheck
  notifications: CompatibilityCheck
  storage: CompatibilityCheck
}

// Comprehensive browser detection
export const detectBrowser = (): BrowserInfo => {
  if (typeof window === 'undefined') {
    return {
      name: 'unknown',
      version: '0',
      isMobile: false,
      isIOS: false,
      isAndroid: false,
      supportsWebkitSpeech: false,
      supportsMozillaSpeech: false,
      supportsMediaDevices: false,
      supportsAudioContext: false,
      supportsWebGL: false,
      supportsServiceWorker: false
    }
  }

  const userAgent = navigator.userAgent
  const isMobile = mobileUtils.isMobile()
  const isIOS = mobileUtils.isIOS()
  const isAndroid = mobileUtils.isAndroid()
  
  let browserName = 'unknown'
  let browserVersion = '0'
  
  // Browser detection with more accuracy
  if (userAgent.includes('Edg/')) {
    browserName = 'edge'
    const match = userAgent.match(/Edg\/(\d+\.\d+)/)
    browserVersion = match ? match[1] : '0'
  } else if (userAgent.includes('Chrome/') && !userAgent.includes('Chromium/')) {
    browserName = 'chrome'
    const match = userAgent.match(/Chrome\/(\d+\.\d+)/)
    browserVersion = match ? match[1] : '0'
  } else if (userAgent.includes('Safari/') && !userAgent.includes('Chrome/')) {
    browserName = 'safari'
    const match = userAgent.match(/Version\/(\d+\.\d+)/)
    browserVersion = match ? match[1] : '0'
  } else if (userAgent.includes('Firefox/')) {
    browserName = 'firefox'
    const match = userAgent.match(/Firefox\/(\d+\.\d+)/)
    browserVersion = match ? match[1] : '0'
  } else if (userAgent.includes('Opera/') || userAgent.includes('OPR/')) {
    browserName = 'opera'
    const match = userAgent.match(/(Opera|OPR)\/(\d+\.\d+)/)
    browserVersion = match ? match[2] : '0'
  } else if (userAgent.includes('Chromium/')) {
    browserName = 'chromium'
    const match = userAgent.match(/Chromium\/(\d+\.\d+)/)
    browserVersion = match ? match[1] : '0'
  }
  
  // Feature detection
  const supportsWebkitSpeech = !!(window as any).webkitSpeechRecognition
  const supportsMozillaSpeech = !!(window as any).SpeechRecognition && !supportsWebkitSpeech
  const supportsMediaDevices = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
  const supportsAudioContext = !!(window.AudioContext || (window as any).webkitAudioContext)
  const supportsWebGL = (() => {
    try {
      const canvas = document.createElement('canvas')
      return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'))
    } catch (e) {
      return false
    }
  })()
  const supportsServiceWorker = !!('serviceWorker' in navigator)
  
  return {
    name: browserName,
    version: browserVersion,
    isMobile,
    isIOS,
    isAndroid,
    supportsWebkitSpeech,
    supportsMozillaSpeech,
    supportsMediaDevices,
    supportsAudioContext,
    supportsWebGL,
    supportsServiceWorker
  }
}

// Speech recognition compatibility check
export const checkSpeechRecognitionSupport = (browserInfo: BrowserInfo): CompatibilityCheck => {
  const { name, version, isMobile, isIOS, supportsWebkitSpeech } = browserInfo
  
  if (supportsWebkitSpeech) {
    let level: 'excellent' | 'good' | 'limited' | 'none' = 'excellent'
    let message = ''
    const recommendations: string[] = []
    
    switch (name) {
      case 'chrome':
        if (parseFloat(version) >= 33) {
          level = 'excellent'
          message = 'üü¢ Chrome bietet vollst√§ndige Spracherkennungsunterst√ºtzung'
          recommendations.push('Optimale Browserumgebung f√ºr Spracherkennung')
        } else {
          level = 'limited'
          message = 'üü° Chrome-Version zu alt f√ºr optimale Spracherkennung'
          recommendations.push('Aktualisieren Sie auf Chrome 33+ f√ºr beste Ergebnisse')
        }
        break
        
      case 'edge':
        if (parseFloat(version) >= 79) {
          level = 'excellent'
          message = 'üî∑ Edge (Chromium) bietet vollst√§ndige Spracherkennungsunterst√ºtzung'
        } else {
          level = 'limited'
          message = 'üü° Edge Legacy hat eingeschr√§nkte Spracherkennungsunterst√ºtzung'
          recommendations.push('Aktualisieren Sie auf die neue Edge-Version (Chromium-basiert)')
        }
        break
        
      case 'safari':
        if (isIOS) {
          level = 'good'
          message = 'üçé Safari iOS bietet grundlegende Spracherkennungsunterst√ºtzung'
          recommendations.push(
            'Stellen Sie sicher, dass HTTPS verwendet wird',
            'Mikrofonberechtigungen in iOS-Einstellungen aktivieren'
          )
        } else {
          level = 'good'
          message = 'üçé Safari macOS bietet grundlegende Spracherkennungsunterst√ºtzung'
          recommendations.push('Chrome bietet zuverl√§ssigere Spracherkennung')
        }
        break
        
      case 'opera':
        level = 'good'
        message = 'üî¥ Opera bietet grundlegende Spracherkennungsunterst√ºtzung'
        recommendations.push('Chrome wird f√ºr beste Spracherkennungsergebnisse empfohlen')
        break
        
      default:
        level = 'good'
        message = '‚úÖ Ihr Browser unterst√ºtzt Spracherkennung'
    }
    
    // Add mobile-specific recommendations
    if (isMobile) {
      recommendations.push(
        'Sprechen Sie in ruhiger Umgebung',
        'Halten Sie das Ger√§t nah am Mund',
        'Verwenden Sie ein externes Mikrofon f√ºr beste Qualit√§t'
      )
    }
    
    return {
      compatible: true,
      message,
      recommendations,
      level
    }
  }
  
  // No speech recognition support
  let message = ''
  const recommendations: string[] = []
  
  switch (name) {
    case 'firefox':
      message = 'ü¶ä Firefox unterst√ºtzt derzeit keine Web Speech API'
      recommendations.push(
        'Verwenden Sie Chrome f√ºr Sprachfunktionen',
        'Firefox arbeitet an der Implementierung',
        'Alternativ: Safari oder Edge verwenden'
      )
      break
      
    case 'safari':
      if (parseFloat(version) < 14.1) {
        message = 'üçé Ihre Safari-Version ist zu alt f√ºr Spracherkennung'
        recommendations.push(
          'Aktualisieren Sie Safari auf Version 14.1+',
          'Oder verwenden Sie Chrome/Edge'
        )
      } else {
        message = 'üçé Safari-Spracherkennung m√∂glicherweise nicht verf√ºgbar'
        recommendations.push('Versuchen Sie Chrome f√ºr bessere Kompatibilit√§t')
      }
      break
      
    default:
      message = '‚ùå Ihr Browser unterst√ºtzt keine Spracherkennung'
      recommendations.push(
        'Installieren Sie Chrome (empfohlen)',
        'Oder verwenden Sie Safari/Edge als Alternative'
      )
  }
  
  return {
    compatible: false,
    message,
    recommendations,
    level: 'none'
  }
}

// Media recording compatibility check
export const checkMediaRecordingSupport = (browserInfo: BrowserInfo): CompatibilityCheck => {
  const { name, supportsMediaDevices } = browserInfo
  
  if (supportsMediaDevices && 'MediaRecorder' in window) {
    return {
      compatible: true,
      message: '‚úÖ Audio-Aufnahme wird vollst√§ndig unterst√ºtzt',
      recommendations: [
        'Mikrofonzugriff erlauben wenn gefragt',
        'F√ºr beste Qualit√§t externes Mikrofon verwenden'
      ],
      level: 'excellent'
    }
  }
  
  const recommendations: string[] = []
  let message = ''
  
  if (!supportsMediaDevices) {
    message = '‚ùå Ger√§tezugriff (Mikrofon) wird nicht unterst√ºtzt'
    recommendations.push(
      'HTTPS verwenden (erforderlich f√ºr Mikrofonzugriff)',
      'Browser aktualisieren'
    )
  } else {
    message = '‚ùå Audio-Aufnahme wird nicht unterst√ºtzt'
    recommendations.push('Modernen Browser verwenden (Chrome, Firefox, Safari)')
  }
  
  return {
    compatible: false,
    message,
    recommendations,
    level: 'none'
  }
}

// Comprehensive feature support check
export const checkAllFeatureSupport = (browserInfo: BrowserInfo): FeatureSupport => {
  return {
    speechRecognition: checkSpeechRecognitionSupport(browserInfo),
    mediaRecording: checkMediaRecordingSupport(browserInfo),
    audioProcessing: {
      compatible: browserInfo.supportsAudioContext,
      message: browserInfo.supportsAudioContext 
        ? '‚úÖ Audio-Verarbeitung unterst√ºtzt' 
        : '‚ùå Audio-Verarbeitung nicht verf√ºgbar',
      recommendations: browserInfo.supportsAudioContext 
        ? ['Audio-Features funktionieren optimal']
        : ['Browser aktualisieren f√ºr Audio-Features'],
      level: browserInfo.supportsAudioContext ? 'excellent' : 'none'
    },
    notifications: {
      compatible: 'Notification' in window,
      message: 'Notification' in window 
        ? '‚úÖ Browser-Benachrichtigungen verf√ºgbar' 
        : '‚ùå Benachrichtigungen nicht unterst√ºtzt',
      recommendations: 'Notification' in window 
        ? ['Benachrichtigungen erlauben f√ºr beste Erfahrung']
        : ['Modernen Browser f√ºr Benachrichtigungen verwenden'],
      level: 'Notification' in window ? 'excellent' : 'none'
    },
    storage: {
      compatible: 'localStorage' in window && 'sessionStorage' in window,
      message: '‚úÖ Browser-Speicher verf√ºgbar',
      recommendations: ['Daten werden lokal gespeichert'],
      level: 'excellent'
    }
  }
}

// Get browser-specific recommendations
export const getBrowserRecommendations = (browserInfo: BrowserInfo): string[] => {
  const { name, version, isMobile } = browserInfo
  const recommendations: string[] = []
  
  switch (name) {
    case 'chrome':
      if (parseFloat(version) < 90) {
        recommendations.push('üîÑ Chrome aktualisieren f√ºr neueste Features')
      }
      recommendations.push('‚úÖ Optimaler Browser f√ºr alle Features')
      break
      
    case 'firefox':
      recommendations.push(
        'ü¶ä Firefox: Keine Spracherkennung verf√ºgbar',
        'üí° Tipp: Chrome f√ºr Sprachfeatures verwenden'
      )
      break
      
    case 'safari':
      if (isMobile) {
        recommendations.push(
          'üçé Safari iOS: Grundfunktionen verf√ºgbar',
          'üí° Tipp: Chrome iOS f√ºr bessere Kompatibilit√§t'
        )
      } else {
        recommendations.push(
          'üçé Safari macOS: Grundfunktionen verf√ºgbar',
          'üí° Tipp: Chrome f√ºr erweiterte Features'
        )
      }
      break
      
    case 'edge':
      if (parseFloat(version) >= 79) {
        recommendations.push('‚úÖ Edge (Chromium): Vollst√§ndige Unterst√ºtzung')
      } else {
        recommendations.push('üîÑ Edge auf Chromium-Version aktualisieren')
      }
      break
      
    default:
      recommendations.push(
        '‚ùå Unbekannter Browser',
        'üí° Chrome, Safari oder Edge empfohlen'
      )
  }
  
  // Mobile-specific recommendations
  if (isMobile) {
    recommendations.push(
      'üì± Mobile Optimierungen aktiv',
      'üîá In ruhiger Umgebung f√ºr beste Ergebnisse'
    )
  }
  
  return recommendations
}

// Export the browser info as a singleton
let cachedBrowserInfo: BrowserInfo | null = null

export const getBrowserInfo = (): BrowserInfo => {
  if (!cachedBrowserInfo) {
    cachedBrowserInfo = detectBrowser()
  }
  return cachedBrowserInfo
}

// Utility to display compatibility status
export const getCompatibilityEmoji = (level: CompatibilityCheck['level']): string => {
  switch (level) {
    case 'excellent': return 'üü¢'
    case 'good': return 'üü°'
    case 'limited': return 'üü†'
    case 'none': return 'üî¥'
    default: return '‚ö™'
  }
}

// Export commonly used functions
export const browserCompatibility = {
  detectBrowser,
  checkSpeechRecognitionSupport,
  checkMediaRecordingSupport,
  checkAllFeatureSupport,
  getBrowserRecommendations,
  getBrowserInfo,
  getCompatibilityEmoji
}

export default browserCompatibility